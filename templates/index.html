<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCuBA Score Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f9fafb; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1, h2 { color: #1f2937; margin-top: 0; }
        button { background-color: #2563eb; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #1d4ed8; }
        input[type="file"] { margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        
        .nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav a { color: #2563eb; text-decoration: none; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; font-size: 14px; }
        th { background: #f9fafb; }
        .badge-fail { background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .badge-pass { background: #d1fae5; color: #065f46; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-height: 80vh; overflow-y: auto; }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="nav">
        <h1>SCuBA Score Dashboard</h1>
        <a href="/settings">âš™ Settings</a>
    </div>
    
    <div class="grid">
        <div class="card">
            <h2>Upload Results</h2>
            <p>Upload ScubaGoggles JSON to calculate score.</p>
            <input type="file" id="fileInput" accept=".json">
            <br>
            <button onclick="uploadAndScore()">Calculate Score</button>
            <div id="status" style="margin-top: 10px; color: #666;"></div>
        </div>

        <div class="card">
            <h2>Latest Score Overview</h2>
            <div id="latestScore">
                <p class="text-gray-500">No score calculated yet.</p>
            </div>
        </div>
    </div>

    <div class="card" id="topFailuresCard" style="display:none;">
        <h2>Top 5 High-Impact Fixes</h2>
        <p>Fixing these rules will have the biggest impact on your score.</p>
        <table>
            <thead><tr><th>Service</th><th>Rule ID</th><th>Weight</th><th>Compensated?</th></tr></thead>
            <tbody id="topFailuresBody"></tbody>
        </table>
    </div>

    <div class="card">
        <h2>Score History by Product</h2>
        <p>Click on any data point to see detailed pass/fail lists for that service.</p>
        <canvas id="scoreChart"></canvas>
    </div>

    <!-- Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Service Details</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        let scoreChart = null;
        let scoreHistory = [];

        async function uploadAndScore() {
            const fileInput = document.getElementById('fileInput');
            const status = document.getElementById('status');
            
            if (!fileInput.files.length) {
                alert('Please select a file first.');
                return;
            }

            const file = fileInput.files[0];
            status.textContent = 'Processing...';

            try {
                const text = await file.text();
                const json = JSON.parse(text);
                
                const response = await fetch('/score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(json)
                });

                if (!response.ok) throw new Error(await response.text());

                const result = await response.json();
                status.textContent = 'Success!';
                
                displayLatest(result);
                displayTopFailures(result.top_failures);
                await loadHistory(); 

            } catch (err) {
                status.textContent = 'Error: ' + err.message;
                console.error(err);
            }
        }

        function displayLatest(data) {
            const container = document.getElementById('latestScore');
            let html = `<div style="font-size: 2em; font-weight: bold; margin-bottom: 10px;">
                ${data.overall_score !== null ? data.overall_score : 'N/A'}
            </div>`;
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
            for (const [svc, metrics] of Object.entries(data.per_service)) {
                html += `<div><strong>${svc}:</strong> ${metrics.score !== null ? metrics.score : 'N/A'}</div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function displayTopFailures(failures) {
            const card = document.getElementById('topFailuresCard');
            const tbody = document.getElementById('topFailuresBody');
            
            if (!failures || failures.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            tbody.innerHTML = failures.map(f => `
                <tr>
                    <td>${f.service}</td>
                    <td>${f.rule}</td>
                    <td>${f.weight}</td>
                    <td>${f.is_compensated ? 'Yes (50%)' : 'No'}</td>
                </tr>
            `).join('');
        }

        async function loadHistory() {
            try {
                const response = await fetch('/score');
                scoreHistory = await response.json();
                updateChart(scoreHistory);
            } catch (err) {
                console.error("Failed to load history", err);
            }
        }

        function updateChart(history) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            
            const services = new Set();
            history.forEach(h => {
                if (h.service_scores) {
                    Object.keys(h.service_scores).forEach(s => services.add(s));
                }
            });

            const labels = history.map(h => new Date(h.timestamp).toLocaleString());
            const datasets = [{
                label: 'Overall',
                data: history.map(h => h.overall_score),
                borderColor: '#000000',
                borderWidth: 3,
                fill: false,
                pointRadius: 5,
                pointHoverRadius: 7
            }];

            const colors = [
                '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', 
                '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef'
            ];
            let colorIdx = 0;

            services.forEach(svc => {
                datasets.push({
                    label: svc,
                    data: history.map(h => h.service_scores[svc] || null),
                    borderColor: colors[colorIdx % colors.length],
                    borderWidth: 1,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 4
                });
                colorIdx++;
            });

            if (scoreChart) {
                scoreChart.destroy();
            }

            scoreChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score' } }
                    },
                    interaction: { mode: 'nearest', intersect: true },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const datasetIndex = elements[0].datasetIndex;
                            const datasetLabel = datasets[datasetIndex].label;
                            const historyItem = scoreHistory[index];
                            
                            showServiceDetails(historyItem.id, datasetLabel);
                        }
                    }
                }
            });
        }

        async function showServiceDetails(scoreId, serviceName) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            modal.style.display = "block";
            title.textContent = `Loading details for ${serviceName}...`;
            body.innerHTML = "";

            try {
                const response = await fetch(`/score/${scoreId}`);
                if (!response.ok) throw new Error("Failed to fetch details");
                const fullResult = await response.json();

                title.textContent = `${serviceName} Details (${fullResult.generated_at})`;

                if (serviceName === 'Overall') {
                    // Show a summary of all services
                    body.innerHTML = "<h3>Per-Service Breakdown</h3><ul>" + 
                        Object.keys(fullResult.per_service).map(s => `<li>${s}: ${fullResult.per_service[s].score}</li>`).join('') + 
                        "</ul>";
                    return;
                }

                const svcData = fullResult.per_service[serviceName];
                if (!svcData) {
                    body.innerHTML = "<p>No data found for this service.</p>";
                    return;
                }

                let html = `<p><strong>Score:</strong> ${svcData.score}</p>`;
                
                // Failures
                html += `<h3>Failures (${svcData.failed.length})</h3>`;
                if (svcData.failed.length > 0) {
                    html += `<table><thead><tr><th>Rule</th><th>Weight</th><th>Compensated</th></tr></thead><tbody>`;
                    html += svcData.failed.map(f => {
                        // f is [rule_id, weight, is_comp]
                        return `<tr><td>${f[0]}</td><td>${f[1]}</td><td>${f[2] ? 'Yes' : 'No'}</td></tr>`;
                    }).join('');
                    html += `</tbody></table>`;
                } else {
                    html += `<p class="badge-pass">No failures!</p>`;
                }

                // Passes
                html += `<h3>Passes (${svcData.passed.length})</h3>`;
                html += `<div style="max-height: 300px; overflow-y: auto;"><ul>`;
                html += svcData.passed.map(p => `<li>${p[0]} (Wt: ${p[1]})</li>`).join('');
                html += `</ul></div>`;

                body.innerHTML = html;

            } catch (err) {
                body.innerHTML = `<p class="error">Error: ${err.message}</p>`;
            }
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = "none";
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>
